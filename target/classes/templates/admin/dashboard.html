<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã - T·∫°p H√≥a PTIT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            font-size: 24px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
        }

        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .admin-nav a:hover, .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 16px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section input, .filter-section select, .filter-section button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filter-section button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        .filter-section button:hover {
            background: #764ba2;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="admin-header">
    <h1>üõí Qu·∫£n Tr·ªã T·∫°p H√≥a PTIT</h1>
    <nav class="admin-nav">
        <a href="/admin" class="active">Dashboard</a>
        <a href="/admin/products">S·∫£n Ph·∫©m</a>
        <a href="/admin/orders">ƒê∆°n H√†ng</a>
        <a href="/logout" class="logout-btn" th:text="'ƒêƒÉng Xu·∫•t (' + ${username} + ')'">ƒêƒÉng Xu·∫•t</a>
    </nav>
</div>

<div class="container">
    <!-- Th·ªëng k√™ c∆° b·∫£n -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon">üì¶</div>
            <div class="number" th:text="${totalProducts}">0</div>
            <div class="label">T·ªïng S·∫£n Ph·∫©m</div>
        </div>

        <div class="stat-card">
            <div class="icon">üõçÔ∏è</div>
            <div class="number" th:text="${totalOrders}">0</div>
            <div class="label">T·ªïng ƒê∆°n H√†ng</div>
        </div>

        <div class="stat-card">
            <div class="icon">‚è≥</div>
            <div class="number" th:text="${pendingOrders}">0</div>
            <div class="label">Ch·ªù X·ª≠ L√Ω</div>
        </div>

        <div class="stat-card">
            <div class="icon">‚úÖ</div>
            <div class="number" th:text="${completedOrders}">0</div>
            <div class="label">Ho√†n Th√†nh</div>
        </div>
    </div>

    <!-- B·ªô l·ªçc th·ªùi gian -->
    <div class="filter-section">
        <label for="startDate">T·ª´ ng√†y:</label>
        <input type="date" id="startDate">
        
        <label for="endDate">ƒê·∫øn ng√†y:</label>
        <input type="date" id="endDate">
        
        <button onclick="loadStatistics()">üîç T√¨m Ki·∫øm</button>
        <button onclick="resetFilter()">üîÑ ƒê·∫∑t L·∫°i</button>
    </div>

    <!-- Th·ªëng k√™ doanh thu -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon">üí∞</div>
            <div class="number" id="totalRevenueDisplay">0‚Ç´</div>
            <div class="label">Doanh Thu</div>
        </div>

        <div class="stat-card">
            <div class="icon">üìä</div>
            <div class="number" id="totalProductsSoldDisplay">0</div>
            <div class="label">S·∫£n Ph·∫©m B√°n ƒê∆∞·ª£c</div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="charts-row">
        <div class="chart-container">
            <h3>üìà Doanh Thu Theo Ng√†y</h3>
            <canvas id="dailyRevenueChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>üìâ ƒê∆°n H√†ng Theo Tr·∫°ng Th√°i</h3>
            <canvas id="orderStatusChart"></canvas>
        </div>
    </div>

    <!-- B·∫£ng doanh s·ªë s·∫£n ph·∫©m -->
    <div class="table-container">
        <h3>üèÜ Doanh S·ªë B√°n Theo S·∫£n Ph·∫©m</h3>
        <table id="productSalesTable">
            <thead>
                <tr>
                    <th>S·∫£n Ph·∫©m</th>
                    <th>S·ªë L∆∞·ª£ng B√°n</th>
                    <th>Doanh Thu</th>
                </tr>
            </thead>
            <tbody id="productSalesBody">
                <tr><td colspan="3" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let revenueChart, statusChart;

    // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh (30 ng√†y g·∫ßn nh·∫•t)
    function setDefaultDates() {
        const endDate = new Date();
        const startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - 30);

        document.getElementById('startDate').valueAsDate = startDate;
        document.getElementById('endDate').valueAsDate = endDate;
    }

    // T·∫£i th·ªëng k√™
    async function loadStatistics() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            alert('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian');
            return;
        }

        try {
            const response = await fetch(`/admin/api/statistics?startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();

            if (data.error) {
                alert('L·ªói: ' + data.error);
                return;
            }

            // C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng
            document.getElementById('totalRevenueDisplay').textContent = 
                new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.totalRevenue);
            document.getElementById('totalProductsSoldDisplay').textContent = data.totalProductsSold + ' s·∫£n ph·∫©m';

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì doanh thu theo ng√†y
            updateDailyRevenueChart(data.dailyRevenue);

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì ƒë∆°n h√†ng theo tr·∫°ng th√°i
            updateOrderStatusChart(data.orderByStatus);

            // C·∫≠p nh·∫≠t b·∫£ng doanh s·ªë s·∫£n ph·∫©m
            updateProductSalesTable(data.productSales);
        } catch (error) {
            console.error('L·ªói:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™');
        }
    }

    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì doanh thu theo ng√†y
    function updateDailyRevenueChart(data) {
        const ctx = document.getElementById('dailyRevenueChart').getContext('2d');
        
        if (revenueChart) revenueChart.destroy();

        revenueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Doanh Thu (ƒë)',
                    data: data.map(d => d.revenue),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + '‚Ç´';
                            }
                        }
                    }
                }
            }
        });
    }

    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì ƒë∆°n h√†ng theo tr·∫°ng th√°i
    function updateOrderStatusChart(data) {
        const ctx = document.getElementById('orderStatusChart').getContext('2d');
        
        if (statusChart) statusChart.destroy();

        const labels = Object.keys(data);
        const values = Object.values(data);
        const colors = ['#667eea', '#764ba2', '#f59e0b', '#10b981', '#ef4444'];

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length)
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // C·∫≠p nh·∫≠t b·∫£ng doanh s·ªë s·∫£n ph·∫©m
    function updateProductSalesTable(products) {
        const tbody = document.getElementById('productSalesBody');
        
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            return;
        }

        tbody.innerHTML = products.map(p => `
            <tr>
                <td>${p.productName}</td>
                <td>${p.quantitySold}</td>
                <td>${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.revenue)}</td>
            </tr>
        `).join('');
    }

    // ƒê·∫∑t l·∫°i b·ªô l·ªçc
    function resetFilter() {
        setDefaultDates();
        loadStatistics();
    }

    // Kh·ªüi t·∫°o
    window.addEventListener('DOMContentLoaded', () => {
        setDefaultDates();
        loadStatistics();
    });
</script>
</body>
</html>