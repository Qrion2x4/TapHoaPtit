<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè h√†ng - TapHoaPtit.online</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <style>
        /* Checkbox styles */
        .item-checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
        }
        
        .item-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transform: scale(1.2);
        }
        
        .cart-item {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .cart-item:hover {
            background: linear-gradient(90deg, #fff5f5 0%, white 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .cart-item.selected {
            background: linear-gradient(90deg, #e8f5e9 0%, white 100%);
            border-left: 4px solid #27ae60;
        }
        
        .cart-item-row-1 {
            display: grid;
            grid-template-columns: auto 120px 1fr auto;
            gap: 25px;
            align-items: center;
        }
        
        .cart-item-row-2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 145px;
        }
        
        .select-all-section {
            background: #f8f9fa;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .select-all-section label {
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        .selected-info {
            margin-left: auto;
            color: #27ae60;
            font-weight: 600;
        }
        
        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .checkout-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Animation styles */
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        @keyframes slideOut {
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
    </style>
</head>
<body>
    <!-- Header Top -->
    <div class="header-top">
        <div class="container">
            <div class="info-item">
                <span>üöö Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë∆°n t·ª´ 200k</span>
                <span style="margin-left: 20px;">üìû Hotline: 1900 1234</span>
            </div>
            <div class="user-actions">
                <div>
                    <span class="user-welcome">Xin ch√†o, <strong th:text="${username}">User</strong>! üëã</span>
                    <a href="/my-orders" class="auth-btn" style="background: rgba(255,255,255,0.2); margin-right: 10px;">üì¶ ƒê∆°n h√†ng</a>
                    <a href="/logout" class="auth-btn btn-logout">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Header Main -->
    <div class="header-main">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon">ü™ô</span>
                <span>TapHoaPtit.online</span>
            </a>
            <div class="search-box">
                <form action="/search" method="get">
                    <input type="text" name="keyword" placeholder="T√¨m ki·∫øm..." required>
                    <button type="submit">üîç</button>
                </form>
            </div>
            <a href="/cart" class="cart-link">
                üõí
                <span class="cart-badge" th:if="${cartCount > 0}" th:text="${cartCount}">0</span>
            </a>
        </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="nav-menu">
        <div class="container">
            <ul>
                <li><a href="/">üè† Trang ch·ªß</a></li>
                <li><a href="/products/category/Th·ª±c ph·∫©m">üåæ Th·ª±c ph·∫©m</a></li>
                <li><a href="/products/category/ƒê·ªì u·ªëng">ü•§ ƒê·ªì u·ªëng</a></li>
                <li><a href="/products/category/Gia v·ªã">üßÇ Gia v·ªã</a></li>
                <li><a href="/products/category/ChƒÉm s√≥c c√° nh√¢n">üß¥ ChƒÉm s√≥c c√° nh√¢n</a></li>
            </ul>
        </div>
    </div>
    
    <!-- Main -->
    <div class="main-content">
        <h1 class="page-title">
            <span>üõí Gi·ªè h√†ng c·ªßa b·∫°n</span>
            <span class="cart-badge-summary" th:if="${cartCount > 0}" th:text="${cartCount} + ' s·∫£n ph·∫©m'">0 s·∫£n ph·∫©m</span>
        </h1>
        
        <!-- Gi·ªè h√†ng tr·ªëng -->
        <div class="cart-container" th:if="${cartItems.size() == 0}">
            <div class="empty-cart">
                <div class="empty-cart-icon">üõí</div>
                <h2>Gi·ªè h√†ng tr·ªëng</h2>
                <p>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng</p>
                <a href="/" class="continue-btn">üõçÔ∏è Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        </div>
        
        <!-- C√≥ s·∫£n ph·∫©m -->
        <div class="cart-container" th:if="${cartItems.size() > 0}">
            <!-- Cart Items -->
            <div class="cart-items-section">
                <h3>S·∫£n ph·∫©m trong gi·ªè</h3>
                
                <!-- SELECT ALL -->
                <div class="select-all-section">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <label for="selectAll">Ch·ªçn t·∫•t c·∫£ (<span id="selectedCount">0</span>/<span th:text="${cartItems.size()}">0</span>)</label>
                    <span class="selected-info" id="selectedInfo">Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o</span>
                </div>
                
                <!-- CART ITEMS -->
                <div class="cart-item" th:each="item : ${cartItems}">
                    <!-- ROW 1: Checkbox + Image + Name + Total -->
                    <div class="cart-item-row-1">
                        <!-- CHECKBOX -->
                        <div class="item-checkbox-wrapper">
                            <input type="checkbox" 
                                   class="item-checkbox" 
                                   th:attr="data-item-id=${item.id},
                                           data-price=${item.product.price},
                                           data-quantity=${item.quantity}"
                                   onchange="updateSelectedItems()">
                        </div>
                        
                        <!-- IMAGE -->
                        <div class="item-image">
                            <div class="item-img" style="overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <img th:if="${item.product.imageUrl != null and item.product.imageUrl.contains('.')}"
                                     th:src="@{'/images/' + ${item.product.imageUrl}}"
                                     alt="SP"
                                     style="width: 100%; height: 100%; object-fit: cover;">

                                <span th:unless="${item.product.imageUrl != null and item.product.imageUrl.contains('.')}"
                                      th:text="${item.product.imageUrl}">üì¶</span>
                            </div>
                        </div>
                        
                        <!-- NAME -->
                        <div class="item-details">
                            <div class="item-name" th:text="${item.product.name}">T√™n s·∫£n ph·∫©m</div>
                            <!-- HI·ªÇN TH·ªä GI√Å -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                <!-- GI√Å B√ÅN (XANH, ƒê·∫¨M) -->
                                <span style="font-weight: bold; color: #667eea; font-size: 15px;" 
                                      th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">50,000ƒë</span>
                                
                                <!-- GI√Å G·ªêC G·∫†CH NGANG + BADGE % -->
                                <div th:if="${item.product.oldPrice != null && item.product.oldPrice > 0}">
                                    <span style="text-decoration: line-through; color: #999; font-size: 12px;">
                                        <span th:text="${#numbers.formatDecimal(item.product.price / (1 - item.product.oldPrice / 100), 0, 'COMMA', 0, 'POINT')}">100,000</span>ƒë
                                    </span>
                                    <span style="margin-left: 8px; background: #feebc8; padding: 2px 8px; border-radius: 3px; color: #7c2d12; font-weight: 600; font-size: 11px;">
                                        -<span th:text="${item.product.oldPrice}">50</span>%
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TOTAL -->
                        <div class="item-right">
                            <div class="item-total" 
                                 th:attr="data-item-id=${item.id}"
                                 th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">0‚Ç´</div>
                        </div>
                    </div>
                    
                    <!-- ROW 2: Price + Actions -->
                    <div class="cart-item-row-2">
                        <!-- PRICE -->
                        <div class="item-price" 
                             th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">0‚Ç´</div>
                        
                        <!-- ACTIONS -->
                        <div class="item-actions">
                            <div class="item-quantity">
                                <button type="button" 
                                        class="quantity-btn decrease-btn"
                                        th:attr="data-item-id=${item.id}"
                                        th:disabled="${item.quantity <= 1}"
                                        onclick="decreaseQuantity(this)">‚àí</button>
                                
                                <span class="quantity-display" 
                                      th:attr="data-item-id=${item.id}"
                                      th:text="${item.quantity}">1</span>
                                
                                <button type="button" 
                                        class="quantity-btn increase-btn"
                                        th:attr="data-item-id=${item.id}"
                                        onclick="increaseQuantity(this)">+</button>
                            </div>
                            
                            <button type="button" 
                                    class="remove-btn"
                                    th:attr="data-item-id=${item.id}"
                                    onclick="removeItem(this)">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cart Summary -->
            <div class="cart-summary">
                <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                
                <div class="summary-row subtotal">
                    <span>T·∫°m t√≠nh (<span id="summarySelectedCount">0</span> s·∫£n ph·∫©m):</span>
                    <span id="selectedTotal">0‚Ç´</span>
                </div>
                
                <div class="summary-row shipping">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span style="color: #27ae60; font-weight: 600;">Mi·ªÖn ph√≠</span>
                </div>
                
                <div class="coupon-section">
                    <input type="text" 
                           placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" 
                           id="coupon-input"
                           style="text-transform: uppercase;">
                    <button class="apply-coupon-btn" onclick="applyCoupon()">√Åp d·ª•ng</button>
                    <div id="coupon-result" style="margin-top: 10px; font-size: 13px;"></div>
                </div>
                
                <div class="summary-row discount" id="discount-row" style="display: none;">
                    <span>Gi·∫£m gi√°:</span>
                    <span id="discountAmount" style="color: #27ae60; font-weight: 600;">0‚Ç´</span>
                </div>
                
                <div class="summary-row total">
                    <span>T·ªïng c·ªông:</span>
                    <span class="total-price" id="finalTotal">0‚Ç´</span>
                </div>
                
                <button type="button" 
                        class="checkout-btn" 
                        id="checkoutBtn"
                        disabled
                        onclick="openOrderModal()">
                    <span>üì¶</span>
                    <span>ƒê·∫∂T H√ÄNG</span>
                    <span>(<span id="checkoutCount">0</span> SP)</span>
                </button>
                
                <a href="/" class="continue-shopping">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        </div>
    </div>
    
    <!-- MODAL ƒê·∫∂T H√ÄNG -->
    <div id="orderModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeOrderModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ X√°c nh·∫≠n th√¥ng tin giao h√†ng</h2>
                <button type="button" class="modal-close" onclick="closeOrderModal()">√ó</button>
            </div>
            
            <form id="orderForm" action="/order/place-selected" method="post">
                <input type="hidden" id="selectedItemIds" name="selectedItemIds">
                
                <!-- HIDDEN INPUT -->
                <input type="hidden" id="appliedCouponCode" name="couponCode">
                <input type="hidden" id="appliedDiscountAmount" name="discountAmount">
                
                <div class="form-group">
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i: <span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i..." required>
                </div>
                
                <div class="form-group">
                    <label for="address">ƒê·ªãa ch·ªâ giao h√†ng: <span class="required">*</span></label>
                    <textarea id="address" name="address" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="note">Ghi ch√∫ (t√πy ch·ªçn):</label>
                    <textarea id="note" name="note" rows="2" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng..."></textarea>
                </div>
                
                <div class="order-summary-modal">
                    <div class="summary-row">
                        <span>S·ªë s·∫£n ph·∫©m:</span>
                        <span id="modalItemCount">0 s·∫£n ph·∫©m</span>
                    </div>
                    <div class="summary-row">
                        <span>T·ªïng ti·ªÅn:</span>
                        <span class="total-price" id="modalTotal">0‚Ç´</span>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeOrderModal()">H·ªßy</button>
                    <button type="submit" class="btn-confirm">‚úì X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div>
                <h3>ü™ô V·ªÅ TapHoaPtit.online</h3>
                <p>T·∫°p h√≥a tr·ª±c tuy·∫øn h√†ng ƒë·∫ßu Vi·ªát Nam</p>
                <p>Giao h√†ng nhanh - Gi√° c·∫£ h·ª£p l√Ω</p>
            </div>
            <div>
                <h3>üìã H·ªó tr·ª£ kh√°ch h√†ng</h3>
                <a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a>
                <a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a>
            </div>
            <div>
                <h3>üìû Li√™n h·ªá</h3>
                <p>Hotline: 1900 1234</p>
                <p>Email: support@taphoaptit.online</p>
            </div>
        </div>
        <div class="copyright">
            ¬© 2025 TapHoaPtit.online
        </div>
    </div>
    
    <script>
        // ==================== COUPON LOGIC ====================
        
        let appliedDiscount = 0;
        let appliedCouponCode = ''; // TH√äM BI·∫æN L∆ØU M√É COUPON
        
        function applyCoupon() {
            const couponInput = document.getElementById('coupon-input');
            const code = couponInput.value.trim().toUpperCase();
            const resultDiv = document.getElementById('coupon-result');
            
            if (!code) {
                showToast('‚ùå Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!', 'error');
                return;
            }
            
            // L·∫§Y T·ªîNG TI·ªÄN C·ª¶A C√ÅC S·∫¢N PH·∫®M ƒê√É CH·ªåN
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m tr∆∞·ªõc khi √°p d·ª•ng m√£!', 'error');
                return;
            }
            
            let selectedTotal = 0;
            checkboxes.forEach(checkbox => {
                const price = parseFloat(checkbox.getAttribute('data-price'));
                const quantity = parseInt(checkbox.getAttribute('data-quantity'));
                selectedTotal += price * quantity;
            });
            
            // Hi·ªÉn th·ªã loading
            const applyBtn = document.querySelector('.apply-coupon-btn');
            applyBtn.disabled = true;
            applyBtn.textContent = 'ƒêang ki·ªÉm tra...';
            
            fetch('/api/cart/apply-coupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `code=${encodeURIComponent(code)}&orderTotal=${selectedTotal}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // L∆ØU COUPON V√Ä DISCOUNT
                    appliedDiscount = data.discount;
                    appliedCouponCode = code; // L∆ØU M√É COUPON
                    
                    // Hi·ªÉn th·ªã UI
                    resultDiv.innerHTML = `<span style="color: #27ae60;">‚úì ${data.message}</span>`;
                    document.getElementById('discount-row').style.display = 'flex';
                    document.getElementById('discountAmount').textContent = '-' + formatMoney(data.discount);
                    
                    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
                    const finalAmount = selectedTotal - data.discount;
                    document.getElementById('finalTotal').textContent = formatMoney(finalAmount);
                    
                    showToast(data.message, 'success');
                    couponInput.disabled = true;
                    applyBtn.textContent = '‚úì ƒê√£ √°p d·ª•ng';
                    applyBtn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                } else {
                    resultDiv.innerHTML = `<span style="color: #e74c3c;">‚úï ${data.message}</span>`;
                    showToast(data.message, 'error');
                    applyBtn.disabled = false;
                    applyBtn.textContent = '√Åp d·ª•ng';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå C√≥ l·ªói x·∫£y ra!', 'error');
                applyBtn.disabled = false;
                applyBtn.textContent = '√Åp d·ª•ng';
            });
        }
        
        // ==================== PHONE VALIDATION ====================
        
        function validateVietnamesePhone(phone) {
            const regex = /^(0|\+84)(3|5|7|8|9)[0-9]{8}$/;
            return regex.test(phone.replace(/\s/g, ''));
        }
        
        // ==================== CHECKBOX LOGIC ====================
        
        function formatMoney(number) {
            return new Intl.NumberFormat('vi-VN').format(number) + '‚Ç´';
        }
        
        function updateSelectedItems() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedCount = checkboxes.length;
            let totalSelected = 0;
            
            checkboxes.forEach(checkbox => {
                const price = parseFloat(checkbox.getAttribute('data-price'));
                const quantity = parseInt(checkbox.getAttribute('data-quantity'));
                totalSelected += price * quantity;
                checkbox.closest('.cart-item').classList.add('selected');
            });
            
            document.querySelectorAll('.item-checkbox:not(:checked)').forEach(checkbox => {
                checkbox.closest('.cart-item').classList.remove('selected');
            });
            
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('summarySelectedCount').textContent = selectedCount;
            document.getElementById('selectedTotal').textContent = formatMoney(totalSelected);
            
            // T√çNH L·∫†I T·ªîNG TI·ªÄN SAU KHI TR·ª™ GI·∫¢M GI√Å
            const finalAmount = totalSelected - appliedDiscount;
            document.getElementById('finalTotal').textContent = formatMoney(finalAmount);
            
            document.getElementById('checkoutCount').textContent = selectedCount;
            
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (selectedCount > 0) {
                checkoutBtn.disabled = false;
                document.getElementById('selectedInfo').textContent = `ƒê√£ ch·ªçn ${selectedCount} s·∫£n ph·∫©m - ${formatMoney(totalSelected)}`;
            } else {
                checkoutBtn.disabled = true;
                document.getElementById('selectedInfo').textContent = 'Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o';
                
                // Reset coupon n·∫øu b·ªè ch·ªçn h·∫øt
                if (appliedDiscount > 0) {
                    resetCoupon();
                }
            }
            
            const totalCheckboxes = document.querySelectorAll('.item-checkbox').length;
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.checked = (selectedCount === totalCheckboxes && totalCheckboxes > 0);
        }
        
        // H√ÄM RESET COUPON
        function resetCoupon() {
            appliedDiscount = 0;
            appliedCouponCode = ''; // X√ìA M√É
            document.getElementById('discount-row').style.display = 'none';
            document.getElementById('discountAmount').textContent = '0‚Ç´';
            
            const couponInput = document.getElementById('coupon-input');
            const applyBtn = document.querySelector('.apply-coupon-btn');
            const resultDiv = document.getElementById('coupon-result');
            
            couponInput.value = '';
            couponInput.disabled = false;
            applyBtn.disabled = false;
            applyBtn.textContent = '√Åp d·ª•ng';
            applyBtn.style.background = '';
            resultDiv.innerHTML = '';
        }
        
        function toggleSelectAll(checkbox) {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            itemCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedItems();
        }
        
        // S·ª¨A H√ÄM openOrderModal - G·ª¨I COUPON V√ÄO FORM
        function openOrderModal() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m!');
                return;
            }
            
            const selectedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-item-id'));
            document.getElementById('selectedItemIds').value = selectedIds.join(',');
            
            // G·ª¨I COUPON V√ÄO HIDDEN FIELDS
            document.getElementById('appliedCouponCode').value = appliedCouponCode;
            document.getElementById('appliedDiscountAmount').value = appliedDiscount;
            
            const selectedCount = checkboxes.length;
            let totalSelected = 0;
            checkboxes.forEach(cb => {
                const price = parseFloat(cb.getAttribute('data-price'));
                const quantity = parseInt(cb.getAttribute('data-quantity'));
                totalSelected += price * quantity;
            });
            
            // HI·ªÇN TH·ªä T·ªîNG TI·ªÄN SAU GI·∫¢M GI√Å TRONG MODAL
            const finalTotal = totalSelected - appliedDiscount;
            
            document.getElementById('modalItemCount').textContent = selectedCount + ' s·∫£n ph·∫©m';
            document.getElementById('modalTotal').textContent = formatMoney(finalTotal);
            
            const modal = document.getElementById('orderModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderModal() {
            const modal = document.getElementById('orderModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOrderModal();
            }
        });
        
        const orderForm = document.getElementById('orderForm');
        if (orderForm) {
            orderForm.addEventListener('submit', function(e) {
                const phone = document.getElementById('phone').value.trim();
                const address = document.getElementById('address').value.trim();
                
                if (!phone || !address) {
                    e.preventDefault();
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return false;
                }
                
                // VALIDATE S·ªê ƒêI·ªÜN THO·∫†I
                if (!validateVietnamesePhone(phone)) {
                    e.preventDefault();
                    alert('‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!\n\nƒê·ªãnh d·∫°ng ƒë√∫ng:\n‚Ä¢ 0xxxxxxxxx (10 s·ªë)\n‚Ä¢ B·∫Øt ƒë·∫ßu b·∫±ng 03, 05, 07, 08, 09\n\nV√≠ d·ª•: 0912345678');
                    return false;
                }
                
                return true;
            });
        }
        
        // ==================== AJAX CART FUNCTIONS ====================
        
        function setButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                button.style.opacity = '0.6';
                button.style.cursor = 'wait';
                button.textContent = '‚è≥';
            } else {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        }
        
        function showToast(message, type = 'success') {
            const oldToast = document.querySelector('.ajax-toast');
            if (oldToast) oldToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'ajax-toast ajax-toast-' + type;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #27ae60, #2ecc71)' : 'linear-gradient(135deg, #e74c3c, #c0392b)'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function increaseQuantity(button) {
            const itemId = button.getAttribute('data-item-id');
            const originalText = button.textContent;
            
            setButtonLoading(button, true);
            
            fetch(`/api/cart/increase/${itemId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const quantitySpan = document.querySelector(`.quantity-display[data-item-id="${itemId}"]`);
                    if (quantitySpan) {
                        quantitySpan.textContent = data.newQuantity;
                        quantitySpan.style.transform = 'scale(1.3)';
                        quantitySpan.style.color = '#27ae60';
                        setTimeout(() => {
                            quantitySpan.style.transform = 'scale(1)';
                            quantitySpan.style.color = '#333';
                        }, 300);
                    }
                    
                    const itemTotalElement = document.querySelector(`.item-total[data-item-id="${itemId}"]`);
                    if (itemTotalElement) {
                        itemTotalElement.textContent = formatMoney(data.itemTotal);
                    }
                    
                    const checkbox = document.querySelector(`.item-checkbox[data-item-id="${itemId}"]`);
                    if (checkbox) {
                        checkbox.setAttribute('data-quantity', data.newQuantity);
                    }
                    
                    // Enable n√∫t tr·ª´ n·∫øu quantity > 1
                    const decreaseBtn = document.querySelector(`.decrease-btn[data-item-id="${itemId}"]`);
                    if (decreaseBtn && data.newQuantity > 1) {
                        decreaseBtn.disabled = false;
                    }
                    
                    updateCartBadge(data.cartCount);
                    updateSelectedItems();
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
                
                button.textContent = originalText;
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('C√≥ l·ªói x·∫£y ra!', 'error');
                button.textContent = originalText;
            })
            .finally(() => {
                setButtonLoading(button, false);
            });
        }
        
        function decreaseQuantity(button) {
            const itemId = button.getAttribute('data-item-id');
            const originalText = button.textContent;
            
            // Ki·ªÉm tra xem c√≥ ph·∫£i quantity = 1 kh√¥ng
            const quantitySpan = document.querySelector(`.quantity-display[data-item-id="${itemId}"]`);
            const currentQuantity = parseInt(quantitySpan.textContent);
            
            if (currentQuantity <= 1) {
                showToast('‚ùå S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† 1. Vui l√≤ng d√πng n√∫t X√≥a ƒë·ªÉ x√≥a s·∫£n ph·∫©m!', 'error');
                return;
            }
            
            setButtonLoading(button, true);
            
            fetch(`/api/cart/decrease/${itemId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.removed) {
                        // Kh√¥ng bao gi·ªù x·∫£y ra v√¨ ƒë√£ check ·ªü tr√™n
                        const cartItem = button.closest('.cart-item');
                        if (cartItem) {
                            cartItem.style.animation = 'slideOut 0.3s ease';
                            setTimeout(() => {
                                cartItem.remove();
                                updateTotalItemsCounter(); // C·∫≠p nh·∫≠t counter
                                checkEmptyCart();
                                updateSelectedItems();
                            }, 300);
                        }
                        showToast('ƒê√£ x√≥a s·∫£n ph·∫©m!', 'success');
                    } else {
                        if (quantitySpan) {
                            quantitySpan.textContent = data.newQuantity;
                        }
                        
                        const itemTotalElement = document.querySelector(`.item-total[data-item-id="${itemId}"]`);
                        if (itemTotalElement) {
                            itemTotalElement.textContent = formatMoney(data.itemTotal);
                        }
                        
                        const checkbox = document.querySelector(`.item-checkbox[data-item-id="${itemId}"]`);
                        if (checkbox) {
                            checkbox.setAttribute('data-quantity', data.newQuantity);
                        }
                        
                        // Disable n√∫t tr·ª´ n·∫øu quantity = 1
                        if (data.newQuantity <= 1) {
                            button.disabled = true;
                        }
                        
                        updateSelectedItems();
                        showToast(data.message, 'success');
                    }
                    
                    updateCartBadge(data.cartCount);
                } else {
                    showToast(data.message, 'error');
                }
                
                button.textContent = originalText;
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('C√≥ l·ªói x·∫£y ra!', 'error');
                button.textContent = originalText;
            })
            .finally(() => {
                setButtonLoading(button, false);
            });
        }
        
        function removeItem(button) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                return;
            }
            
            const itemId = button.getAttribute('data-item-id');
            const originalText = button.textContent;
            
            setButtonLoading(button, true);
            
            fetch(`/api/cart/remove/${itemId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cartItem = button.closest('.cart-item');
                    if (cartItem) {
                        cartItem.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            cartItem.remove();
                            
                            // C·∫≠p nh·∫≠t counter tr∆∞·ªõc khi check empty
                            updateTotalItemsCounter();
                            checkEmptyCart();
                            updateSelectedItems();
                        }, 300);
                    }
                    
                    updateCartBadge(data.cartCount);
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                    button.textContent = originalText;
                    setButtonLoading(button, false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('C√≥ l·ªói x·∫£y ra!', 'error');
                button.textContent = originalText;
                setButtonLoading(button, false);
            });
        }
        
        function updateCartBadge(count) {
            const cartBadge = document.querySelector('.cart-badge');
            if (cartBadge) {
                cartBadge.textContent = count;
                cartBadge.style.animation = 'pulse 0.5s ease';
                setTimeout(() => {
                    cartBadge.style.animation = '';
                }, 500);
            }
            
            const summaryBadge = document.querySelector('.cart-badge-summary');
            if (summaryBadge) {
                summaryBadge.textContent = count + ' s·∫£n ph·∫©m';
            }
        }
        
        function checkEmptyCart() {
            const cartItems = document.querySelectorAll('.cart-item');
            console.log('Checking empty cart, items left:', cartItems.length);
            
            if (cartItems.length === 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                updateTotalItemsCounter();
            }
        }
        
        // C·∫≠p nh·∫≠t t·ªïng s·ªë s·∫£n ph·∫©m
        function updateTotalItemsCounter() {
            const totalItems = document.querySelectorAll('.cart-item').length;
            const totalCounterSpan = document.querySelector('.select-all-section label');
            
            if (totalCounterSpan) {
                const selectedCount = document.getElementById('selectedCount').textContent;
                totalCounterSpan.innerHTML = `Ch·ªçn t·∫•t c·∫£ (<span id="selectedCount">${selectedCount}</span>/${totalItems})`;
            }
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            updateSelectedItems();
        });
    </script>
</body>
</html>