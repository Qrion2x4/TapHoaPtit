<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt ƒë∆°n h√†ng - Admin</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }

        .container {
            max-width: 1050px;
            margin: 30px auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        h2 { font-size: 24px; color: #2d3748; }

        .back-btn {
            background: #edf2f7;
            color: #4a5568;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
        }

        /* Badge tr·∫°ng th√°i */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            display: inline-block;
        }

        .status-pending { background: #feebc8; color: #7c2d12; }
        .status-confirmed { background: #bee3f8; color: #2c5282; }
        .status-shipping { background: #c6f6d5; color: #22543d; }
        .status-completed { background: #9ae6b4; color: #22543d; }
        .status-cancelled { background: #fed7d7; color: #742a2a; }
        .status-request { background: #e9d8fd; color: #553c9a; }

        /* Section */
        .section { margin-top: 30px; }
        .section-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            color: #718096;
            margin-bottom: 15px;
        }

        /* Info boxes */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-box {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #edf2f7;
        }

        .label { font-size: 13px; color: #718096; }
        .value { font-size: 16px; font-weight: 600; margin-top: 3px; }

        /* Ghi ch√∫ */
        .note-box {
            margin-top: 15px;
            padding: 12px;
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            color: #b7791f;
            line-height: 1.5;
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; }

        .product-info { display: flex; gap: 12px; align-items: center; }
        .product-img {
            width: 50px; height: 50px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        /* Total */
        .total-section { display: flex; justify-content: flex-end; margin-top: 20px; }
        .total-box { width: 300px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .final-row {
            display: flex; justify-content: space-between;
            padding-top: 10px; border-top: 2px solid #eee;
            font-size: 18px; font-weight: bold; color: #e53e3e;
        }

        /* Request cancel */
        .action-area {
            background: #fff5f5;
            padding: 20px;
            border-radius: 8px;
            border: 1px dashed #fc8181;
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; color: #fff; font-weight: bold; }
        .btn-approve { background: #48bb78; }
        .btn-reject { background: #f56565; }

        /* Logs */
        .action-badge {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 6px;
            font-weight: 600;
            background: #edf2f7;
            color: #2d3748;
            display: inline-block;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- HEADER -->
    <div class="header">
        <h2>
            ƒê∆°n h√†ng #<span th:text="${order.id}"></span>
            <span class="status-badge"
                  th:classappend="${
                    order.status == 'PENDING' ? 'status-pending' :
                    order.status == 'CONFIRMED' ? 'status-confirmed' :
                    order.status == 'SHIPPING' ? 'status-shipping' :
                    order.status == 'COMPLETED' ? 'status-completed' :
                    order.status == 'CANCEL_REQUESTED' ? 'status-request' : 'status-cancelled'
                 }"
                  style="margin-left: 10px;"
                  th:text="${
                    order.status == 'PENDING' ? '‚è≥ Ch·ªù x·ª≠ l√Ω' :
                    order.status == 'CONFIRMED' ? 'üì¶ ƒê√£ x√°c nh·∫≠n' :
                    order.status == 'SHIPPING' ? 'üöö ƒêang giao' :
                    order.status == 'COMPLETED' ? 'üéâ Ho√†n th√†nh' :
                    order.status == 'CANCEL_REQUESTED' ? '‚ö†Ô∏è Y√™u c·∫ßu h·ªßy' : '‚ùå ƒê√£ h·ªßy'
                 }"></span>
        </h2>

        <a href="/admin/orders" class="back-btn">‚Üê Quay l·∫°i</a>
    </div>

    <!-- INFO -->
    <div class="section">
        <div class="section-title">üìå Th√¥ng tin nh·∫≠n h√†ng</div>

        <div class="info-grid">
            <div class="info-box">
                <div class="label">Ng∆∞·ªùi nh·∫≠n</div>
                <div class="value"
                     th:text="${order.user != null ? (order.user.fullName != null ? order.user.fullName : order.user.username) : 'N/A'}">
                </div>
                <small style="color:#666;margin-top:4px;display:block;" th:text="${order.phone}"></small>
            </div>

            <div class="info-box">
                <div class="label">ƒê·ªãa ch·ªâ</div>
                <div class="value" th:text="${order.address}"></div>
            </div>

            <div class="info-box">
                <div class="label">Ng√†y ƒë·∫∑t h√†ng</div>
                <div class="value" th:text="${#temporals.format(order.createdAt, 'HH:mm dd/MM/yyyy')}"></div>
            </div>
        </div>

        <!-- GHI CH√ö -->
        <div th:if="${order.note != null && order.note != ''}" class="note-box">
            <strong>üìù Ghi ch√∫:</strong>
            <div th:each="line : ${#strings.split(order.note, '|')}">
                <div th:text="${line}"></div>
            </div>
        </div>
    </div>

    <!-- PRODUCTS -->
    <div class="section">
        <div class="section-title">üì¶ S·∫£n ph·∫©m</div>

        <table>
            <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th style="width: 80px; text-align:center;">SL</th>
                <th style="width: 150px; text-align:right;">ƒê∆°n gi√°</th>
                <th style="width: 150px; text-align:right;">Th√†nh ti·ªÅn</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="item : ${order.orderItems}">
                <td>
                    <div class="product-info">
                        <img th:src="@{'/images/' + ${item.product.imageUrl}}"
                             class="product-img"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <span th:text="${item.product.name}"></span>
                    </div>
                </td>

                <td style="text-align:center;" th:text="${item.quantity}"></td>

                <td style="text-align:right;"
                    th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></td>

                <td style="text-align:right;font-weight:bold;"
                    th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></td>
            </tr>
            </tbody>
        </table>

        <!-- TOTAL -->
        <div class="total-section">
            <div class="total-box">
                <div class="total-row">
                    <span>T·ªïng ti·ªÅn h√†ng:</span>
                    <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></span>
                </div>

                <div class="final-row">
                    <span>T·ªïng thanh to√°n:</span>
                    <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- CANCEL REQUEST -->
    <div class="action-area" th:if="${order.status == 'CANCEL_REQUESTED'}">
        <div>
            <h3 style="color:#c53030;margin-bottom:5px;">‚ö†Ô∏è Y√™u c·∫ßu h·ªßy ƒë∆°n</h3>
            <p>Kh√°ch h√†ng mu·ªën h·ªßy ƒë∆°n n√†y.</p>
        </div>

        <div style="display:flex;gap:10px;">
            <form th:action="@{/admin/orders/{id}/approve-cancel(id=${order.id})}" method="post">
                <button class="btn btn-approve" onclick="return confirm('X√°c nh·∫≠n h·ªßy?')">‚úî ƒê·ªìng √Ω h·ªßy</button>
            </form>

            <form th:action="@{/admin/orders/{id}/reject-cancel(id=${order.id})}" method="post">
                <button class="btn btn-reject" onclick="return confirm('T·ª´ ch·ªëi h·ªßy?')">‚úñ T·ª´ ch·ªëi</button>
            </form>
        </div>
    </div>

    <!-- LOG TABLE -->
    <div class="section" th:if="${logs != null && not #lists.isEmpty(logs)}">
        <div class="section-title">üìù L·ªãch s·ª≠ x·ª≠ l√Ω</div>

        <table>
            <thead>
            <tr>
                <th>Th·ªùi gian</th>
                <th>H√†nh ƒë·ªông</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                <th>Chi ti·∫øt</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="log : ${logs}">
                <td th:text="${#temporals.format(log.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                <td><span class="action-badge" th:text="${log.action}"></span></td>
                <td th:text="${log.actor}"></td>
                <td th:text="${log.description}"></td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

</body>
</html>
